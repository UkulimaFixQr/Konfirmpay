<!DOCTYPE html>
<html>
<head>
  <title>KonfirmPay Admin</title>
  <meta charset="UTF-8" />
  <style>
    body { font-family: Arial; background:#f5f5f5; margin:0 }
    .lock, .dash { height:100vh; display:flex; align-items:center; justify-content:center }
    .card { background:white; padding:30px; width:360px; border-radius:10px }
    .dash { display:none; padding:20px; align-items:flex-start }
    h2 { margin-top:0 }
    button { padding:10px; width:100%; margin-top:10px }
    table { width:100%; border-collapse:collapse; margin-top:20px }
    th, td { border:1px solid #ccc; padding:8px }
    .cards { display:grid; grid-template-columns:repeat(3,1fr); gap:15px }
    .cardbox { background:white; padding:15px; border-radius:8px }
  </style>
</head>
<body>

<div class="lock" id="lock">
  <div class="card">
    <h2>Admin Login</h2>
    <input id="pin" type="password" placeholder="PIN" />
    <button onclick="login()">Login</button>
    <p id="err"></p>
  </div>
</div>

<div class="dash" id="dash">
  <div style="width:100%">
    <h2>KonfirmPay Revenue</h2>

    <div class="cards">
      <div class="cardbox"><b>Total Revenue</b><br><span id="total"></span></div>
      <div class="cardbox"><b>Today</b><br><span id="today"></span></div>
      <div class="cardbox"><b>Paid Verifications</b><br><span id="count"></span></div>
    </div>

    <h3>Verification Logs</h3>
    <table>
      <thead>
        <tr>
          <th>Phone</th>
          <th>Amount</th>
          <th>Fee</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="logs"></tbody>
    </table>
  </div>
</div>

<script>
async function login() {
  const res = await fetch("/admin/verify-pin", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ pin: pin.value })
  });

  if (res.ok) {
    lock.style.display="none";
    dash.style.display="flex";
    loadRevenue();
  } else {
    err.textContent="Invalid PIN";
  }
}

async function loadRevenue() {
  const summary = await (await fetch("/admin/revenue/summary")).json();
  total.textContent = "KES " + summary.total_revenue;
  today.textContent = "KES " + summary.today_revenue;
  count.textContent = summary.paid_verifications;

  const logsData = await (await fetch("/admin/revenue/logs")).json();
  logs.innerHTML="";
  logsData.forEach(l=>{
    logs.innerHTML += `<tr>
      <td>${l.phone}</td>
      <td>${l.intended_amount}</td>
      <td>${l.verification_fee}</td>
      <td>${new Date(l.created_at).toLocaleString()}</td>
    </tr>`;
  });
}
</script>

</body>
</html>
